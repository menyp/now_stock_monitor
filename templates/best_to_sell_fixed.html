<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOW Stock - Best Day to Sell</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ServiceNow Stock Monitor</h1>
            <nav>
                <ul>
                    <li><a href="/">Home</a></li>
                    <li><a href="/chart">Chart</a></li>
                    <li><a href="/peaks">Peaks</a></li>
                    <li><a href="/entry-points">Entry Points</a></li>
                    <li><a class="active" href="/best-to-sell">Best to Sell</a></li>
                    <li><a href="/best-to-buy-sp">S&P 500 Best to Buy</a></li>
                </ul>
            </nav>
        </header>
        
        <main>
            <h2>Best Day to Sell Stock</h2>
            
            <p class="description">
                This page shows the best day to sell ServiceNow stock based on profitability scores.
                Profitability is calculated by comparing the stock price change to USD/ILS exchange rate changes.
                <span class="tooltip-container">
                    <i class="info-icon">i</i>
                    <span class="tooltip-text">
                        {{ score_explanation|safe }}
                    </span>
                </span>
            </p>
            
            <div class="timeframe-selector">
                <label for="timeframe">Timeframe:</label>
                <select id="timeframe" onchange="changeTimeframe(this.value)">
                    <option value="30" {% if timeframe == 30 %}selected{% endif %}>30 Days</option>
                    <option value="60" {% if timeframe == 60 %}selected{% endif %}>60 Days</option>
                    <option value="90" {% if timeframe == 90 %}selected{% endif %}>90 Days</option>
                </select>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Recommendation</h3>
                    <div class="stat-value recommendation">{{ recommendation_text|safe }}</div>
                </div>
                <div class="stat-card highlight">
                    <h3>Best Day to Sell</h3>
                    <div class="stat-value">{{ formatted_best_date }}</div>
                    <div class="stat-desc">Score: {{ formatted_best_profit }}/100</div>
                </div>
                <div class="stat-card">
                    <h3>Current Metrics</h3>
                    <div class="stat-value">${{ formatted_current_stock }} / {{ formatted_current_rate }} ILS</div>
                    <div class="stat-desc">Score: {{ formatted_current_profit }}/100</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="profitabilityChart"></canvas>
            </div>
        </main>
        
        {% if common_dates %}
        <script>
        // Chart data from backend
        const dates = {{ dates_json|safe }};
        const profitabilityData = {{ profitability_json|safe }};
        const stockPricesData = {{ stock_prices_json|safe }};
        const exchangeRatesData = {{ exchange_rates_json|safe }};
        const bestDate = "{{ best_date|safe }}"; // Best day from backend
        const formattedBestDate = "{{ formatted_best_date|safe }}"; // Formatted date shown in blue box
        
        console.log('Backend best date:', bestDate);
        console.log('Formatted best date (blue box):', formattedBestDate);
        
        // Initialize Chart.js
        document.addEventListener('DOMContentLoaded', function() {
            if (dates.length > 0) {
                const ctx = document.getElementById('profitabilityChart').getContext('2d');
                
                // Initialize best date index to highlight the gold dot
                let bestDateIndex = -1;
                
                // STEP 1: First check if the formatted best date appears exactly in the dates array
                for (let i = 0; i < dates.length; i++) {
                    const dateStr = dates[i].toString();
                    if (dateStr === formattedBestDate || dateStr.includes(formattedBestDate)) {
                        bestDateIndex = i;
                        console.log('EXACT MATCH: Found best date at index', i, 'with value', dateStr);
                        break;
                    }
                }
                
                // STEP 2: If not found directly, try parsing date components from both strings
                if (bestDateIndex === -1) {
                    console.log('No exact match found. Trying component matching...');
                    
                    // Parse backend date (YYYY-MM-DD format)
                    let backendYear, backendMonth, backendDay;
                    
                    if (bestDate.includes('-')) {
                        const parts = bestDate.split('-');
                        if (parts.length === 3) {
                            backendYear = parts[0];
                            backendMonth = parts[1].replace(/^0+/, ''); // Remove leading zeros
                            backendDay = parts[2].replace(/^0+/, '');   // Remove leading zeros
                            
                            console.log('Backend date components:', backendYear, backendMonth, backendDay);
                            
                            // Now check each date in the array for matching components
                            for (let i = 0; i < dates.length; i++) {
                                const dateStr = dates[i].toString().toLowerCase();
                                
                                // Check for common formats that might contain our components
                                if ((dateStr.includes(backendYear) && dateStr.includes(backendMonth) && dateStr.includes(backendDay)) ||
                                    (dateStr.includes(backendMonth + '/' + backendDay) || dateStr.includes(backendDay + '/' + backendMonth)) && dateStr.includes(backendYear)) {
                                    bestDateIndex = i;
                                    console.log('COMPONENT MATCH: Found matching date components at index', i, 'with string', dateStr);
                                    break;
                                }
                            }
                        }
                    }
                }
                
                // STEP 3: If still not found, use the highest profitability score
                if (bestDateIndex === -1) {
                    console.log('Component matching failed. Using maximum profitability value...');
                    
                    let maxProfit = -Infinity;
                    let maxProfitIndex = 0;
                    
                    for (let i = 0; i < profitabilityData.length; i++) {
                        if (profitabilityData[i] > maxProfit) {
                            maxProfit = profitabilityData[i];
                            maxProfitIndex = i;
                        }
                    }
                    
                    bestDateIndex = maxProfitIndex;
                    console.log('Using max profitability at index:', bestDateIndex, 'with date:', dates[bestDateIndex]);
                }
                
                // Ensure we have a valid index
                if (bestDateIndex === -1 || bestDateIndex >= dates.length) {
                    console.warn('Invalid best date index. Defaulting to first date.');
                    bestDateIndex = 0;
                }
                
                console.log('Final best date index for gold dot:', bestDateIndex, 'with date:', dates[bestDateIndex]);
                
                // Create chart with the best day highlighted
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Profitability Score (Blue)',
                                data: profitabilityData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                tension: 0.2,
                                fill: true,
                                yAxisID: 'y',
                                pointRadius: function(context) {
                                    return context.dataIndex === bestDateIndex ? 8 : 3;
                                },
                                pointBackgroundColor: function(context) {
                                    return context.dataIndex === bestDateIndex ? 'gold' : 'rgba(54, 162, 235, 1)';
                                },
                                pointBorderColor: function(context) {
                                    return context.dataIndex === bestDateIndex ? 'goldenrod' : 'rgba(54, 162, 235, 1)';
                                },
                                pointBorderWidth: function(context) {
                                    return context.dataIndex === bestDateIndex ? 2 : 1;
                                },
                                pointStyle: 'circle',
                                pointHoverRadius: 7
                            },
                            {
                                label: 'NOW Stock Price (Red)',
                                data: stockPricesData,
                                backgroundColor: 'rgba(255, 99, 132, 0.0)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                tension: 0.2,
                                yAxisID: 'y1',
                                pointRadius: 3,
                                fill: false
                            },
                            {
                                label: 'USD/ILS Rate (Teal)',
                                data: exchangeRatesData,
                                backgroundColor: 'rgba(75, 192, 192, 0.0)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 2,
                                tension: 0.2,
                                yAxisID: 'y2',
                                pointRadius: 3,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        stacked: false,
                        animation: {
                            duration: 1000
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        let title = dates[index];
                                        // Add special indicator for best day
                                        if (index === bestDateIndex) {
                                            title += ' (Best Day to Sell)';
                                        }
                                        return title;
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        
                                        if (context.datasetIndex === 0) {
                                            return label + String(context.parsed.y);
                                        } else if (context.datasetIndex === 1) {
                                            return label + String(context.parsed.y);
                                        } else {
                                            return label + String(context.parsed.y) + ' ILS';
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Profitability Score'
                                },
                                min: 0,
                                max: 100,
                                ticks: {
                                    color: 'rgba(54, 162, 235, 1)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Stock Price (USD)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    color: 'rgba(255, 99, 132, 1)',
                                    callback: function(value) {
                                        return String(value) + ' points';
                                    }
                                }
                            },
                            y2: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'USD/ILS Rate'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    color: 'rgba(75, 192, 192, 1)'
                                }
                            }
                        }
                    }
                });
            }
        });
        
        // Handle timeframe change
        function changeTimeframe(days) {
            window.location.href = '/best-to-sell?timeframe=' + days;
        }
        </script>
        {% endif %}
        
        <footer>
            <p>&copy; 2023-2025 ServiceNow Stock Monitor</p>
        </footer>
    </div>
</body>
</html>
